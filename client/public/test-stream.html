<!DOCTYPE html>
<html>
<head>
  <title>Stream Test</title>
  <style>
    body { font-family: monospace; padding: 20px; }
    #output { white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; margin-top: 10px; min-height: 200px; }
    #status { font-weight: bold; margin: 10px 0; }
    button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Streaming Test</h1>
  <button onclick="testStream()">Test Stream</button>
  <div id="status"></div>
  <div id="output"></div>

  <script>
    const output = document.getElementById('output');
    const status = document.getElementById('status');

    async function testStream() {
      output.textContent = '';
      status.textContent = 'ğŸ”„ Starting test...';

      try {
        const response = await fetch('/api/invoke_endpoint', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            agent_id: 'databricks-agent-01',
            messages: [{ role: 'user', content: 'Say hello briefly' }],
            stream: true
          })
        });

        console.log('Response status:', response.status);
        console.log('Content-Type:', response.headers.get('content-type'));
        output.textContent += `Response: ${response.status} ${response.statusText}\n`;
        output.textContent += `Content-Type: ${response.headers.get('content-type')}\n\n`;

        if (!response.ok) {
          const text = await response.text();
          output.textContent += `ERROR: ${text}`;
          status.textContent = 'âŒ Failed';
          return;
        }

        if (!response.body) {
          output.textContent += 'ERROR: No response body!';
          status.textContent = 'âŒ No body';
          return;
        }

        status.textContent = 'ğŸŒŠ Reading stream...';
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let eventCount = 0;
        let fullText = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) {
            output.textContent += `\n\nâœ… Stream complete! Received ${eventCount} events`;
            output.textContent += `\n\nğŸ“ Full text: ${fullText}`;
            status.textContent = `âœ… Complete (${eventCount} events)`;
            break;
          }

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop() || '';

          for (const line of lines) {
            if (!line.trim()) continue;
            if (!line.startsWith('data: ')) continue;

            const data = line.slice(6).trim();
            if (!data || data === '[DONE]') continue;

            try {
              const event = JSON.parse(data);
              eventCount++;

              if (event.type === 'response.output_text.delta') {
                fullText += event.delta;
                output.textContent += event.delta;
                console.log(`Delta #${eventCount}:`, event.delta);
              } else {
                console.log(`Event #${eventCount}:`, event.type);
              }

              status.textContent = `ğŸŒŠ Streaming... (${eventCount} events)`;
            } catch (e) {
              console.error('Parse error:', e, 'Data:', data.substring(0, 100));
            }
          }
        }
      } catch (error) {
        output.textContent += `\n\nERROR: ${error.message}`;
        status.textContent = `âŒ Error: ${error.message}`;
        console.error('Test failed:', error);
      }
    }
  </script>
</body>
</html>
